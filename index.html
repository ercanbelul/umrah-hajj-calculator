<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Umre Hesaplama SÃœPER PRO - by Ercan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; user-select: none; }
        #app { max-width: 1000px; margin: 20px auto; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 12px; border-left: 5px solid #1976D2; }
        h3 { color: #1976D2; margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        label { display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: #1976D2; outline: none; }
        button { width: 100%; background: linear-gradient(135deg, #2E7D32, #4CAF50); color: white; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .nights-display, .total-display { padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 15px; flex: 1; }
        .nights-display { background: #e3f2fd; }
        .total-display { background: #e8f5e9; }
        @media (max-width: 768px) { .form-row { flex-direction: column; gap: 15px; } }
    </style>
</head>
<body>
    <div id="app">
        <h1>ğŸ•‹ Umre Hac SÃœPER PRO Sistem</h1>
        
        <div class="section">
            <h3>ğŸ’¾ VERÄ° YÃ–NETÄ°MÄ°</h3>
            <div class="form-row">
                <button onclick="saveCalculation()" style="background: #4CAF50;">ğŸ’¾ HesaplamayÄ± Kaydet</button>
                <button onclick="document.getElementById('fileInput').click()" style="background: #2196F3;">ğŸ“‚ HesaplamayÄ± YÃ¼kle</button>
                <button onclick="exportToExcel()" style="background: #1D6F42;">ğŸ“Š Excel'e Aktar</button>
            </div>
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">
        </div>

        <div class="section">
            <h3>ğŸ—“ï¸ SEYAHAT TARÄ°HÄ°</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>BaÅŸlangÄ±Ã§ Tarihi</label>
                    <input type="date" id="travelStartDate" onchange="calculateDateInfo()">
                </div>
                <div class="form-group">
                    <label>BitiÅŸ Tarihi</label>
                    <input type="date" id="travelEndDate" onchange="calculateDateInfo()">
                </div>
            </div>
            <div class="form-row">
                <div class="nights-display" id="daysUntilTravel">Tarih seÃ§in</div>
                <div class="total-display" id="totalTravelDays">0 gÃ¼n</div>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ‘¥ GRUP BÄ°LGÄ°LERÄ°</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>MÃ¼ÅŸteri / Grup AdÄ±</label>
                    <input type="text" id="customerName" placeholder="Rapor iÃ§in Ã¶nemli">
                </div>
                <div class="form-group">
                    <label>Yolcu SayÄ±sÄ±</label>
                    <input type="number" id="paxCount" placeholder="Ã–rn: 4" min="1" oninput="calculateAll()">
                </div>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ’µ TEMEL MALÄ°YETLER (KiÅŸi BaÅŸÄ±)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Vize Ãœcreti (USD)</label>
                    <input type="number" id="visaCost" value="145" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>UÃ§ak Bileti (USD)</label>
                    <input type="number" id="flightCost" placeholder="Ã–rn: 850" oninput="calculateAll()">
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ¨ OTEL MALÄ°YETLERÄ° (Gecelik / SAR)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Mekke Otel FiyatÄ± (KiÅŸi BaÅŸÄ±)</label>
                    <input type="number" id="makkahHotelCost" placeholder="Ã–rn: 80" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>Medine Otel FiyatÄ± (KiÅŸi BaÅŸÄ±)</label>
                    <input type="number" id="madinahHotelCost" placeholder="Ã–rn: 60" oninput="calculateAll()">
                </div>
            </div>
             <div class="form-row">
                <div class="form-group">
                    <label>Mekke'de KalÄ±nacak Gece</label>
                    <input type="number" id="makkahNights" placeholder="Ã–rn: 10" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>Medine'de KalÄ±nacak Gece</label>
                    <input type="number" id="madinahNights" placeholder="Ã–rn: 4" oninput="calculateAll()">
                </div>
            </div>
        </div>

        <div class="section">
            <h3>âš™ï¸ KÃ‚R ve KUR</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>KÃ¢r YÃ¼zdesi (%)</label>
                    <input type="number" id="profitPercentage" value="15" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>1 USD = ? SAR</label>
                    <input type="number" id="exchangeRate" placeholder="Kur bekleniyor..." step="0.0001" oninput="calculateAll()">
                </div>
            </div>
        </div>
        
        <button onclick="calculateAll()">ğŸ’° HESAPLA</button>
        <button onclick="resetForm()" style="background: #D32F2F;">ğŸ”„ SIFIRLA</button>

        <div id="result" class="section" style="display:none; background-color: #e0f2f1;">
            <h3 style="color: #00796b;">ğŸ“Š HESAPLAMA SONUCU</h3>
            <div id="resultContent" style="font-size: 1.1em; line-height: 1.8;"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    fetchLiveRates();
});

// === API ve KUR Ä°ÅLEMLERÄ° ===
async function fetchLiveRates() {
    // -----------------------------------------------------------------------
    // !!! BURAYA KENDÄ° YENÄ° VE GÄ°ZLÄ° API ANAHTARINIZI GÄ°RÄ°N !!!
    // -----------------------------------------------------------------------
    const apiKey = "6c24409c9a57c109735b8d47";

    if (!apiKey || apiKey === "YENÄ°_VE_GÄ°ZLÄ°_ANAHTARINIZI_BURAYA_YAPIÅTIRIN") {
        console.warn("API AnahtarÄ± eksik. LÃ¼tfen kod iÃ§erisine anahtarÄ±nÄ±zÄ± girin. VarsayÄ±lan kur (3.75) kullanÄ±lÄ±yor.");
        getElement('exchangeRate').value = 3.75;
        return;
    }

    try {
        const response = await fetch(`https://v6.exchangerate-api.com/v6/${apiKey}/latest/USD`);
        if (!response.ok) throw new Error('API yanÄ±tÄ± baÅŸarÄ±sÄ±z oldu.');
        const data = await response.json();
        const rate = data.conversion_rates.SAR;
        if (rate) {
            getElement('exchangeRate').value = rate.toFixed(4);
        } else {
            throw new Error('SAR kuru verisi bulunamadÄ±.');
        }
    } catch (error) {
        console.error("Kur Ã§ekme hatasÄ±:", error);
        getElement('exchangeRate').value = 3.75; // Hata durumunda varsayÄ±lan kur
    }
}

// === HESAPLAMA FONKSÄ°YONLARI ===
function calculateAll() {
    const paxCount = getValue('paxCount', true);
    if (paxCount === 0) {
        hide('result');
        return;
    }

    // DeÄŸerleri al
    const visaCostUSD = getValue('visaCost');
    const flightCostUSD = getValue('flightCost');
    const makkahHotelCostSAR = getValue('makkahHotelCost');
    const madinahHotelCostSAR = getValue('madinahHotelCost');
    const makkahNights = getValue('makkahNights', true);
    const madinahNights = getValue('madinahNights', true);
    const profitPercentage = getValue('profitPercentage');
    const exchangeRate = getValue('exchangeRate');

    if (exchangeRate === 0) {
        alert("LÃ¼tfen geÃ§erli bir dÃ¶viz kuru girin veya bekleyin.");
        return;
    }

    // Maliyetleri hesapla
    const baseCostUSD = visaCostUSD + flightCostUSD;
    const hotelCostSAR = (makkahHotelCostSAR * makkahNights) + (madinahHotelCostSAR * madinahNights);
    
    const totalCostSAR_beforeProfit = (baseCostUSD * exchangeRate) + hotelCostSAR;
    const profitAmountSAR = totalCostSAR_beforeProfit * (profitPercentage / 100);
    const finalPricePerPersonSAR = totalCostSAR_beforeProfit + profitAmountSAR;
    
    const totalGroupPriceSAR = finalPricePerPersonSAR * paxCount;

    // SonuÃ§larÄ± global bir deÄŸiÅŸkende sakla (Excel iÃ§in)
    window.lastCalculation = {
        paxCount,
        visaCostUSD,
        flightCostUSD,
        hotelCostSAR,
        totalCostSAR_beforeProfit,
        profitAmountSAR,
        finalPricePerPersonSAR,
        totalGroupPriceSAR
    };

    displayResults(window.lastCalculation);
}

function displayResults(data) {
    const resultDiv = getElement('resultContent');
    const toSAR = (val) => val.toFixed(2) + " SAR";

    resultDiv.innerHTML = `
        <p><strong>KiÅŸi BaÅŸÄ± Toplam Maliyet (KÃ¢r HariÃ§):</strong> ${toSAR(data.totalCostSAR_beforeProfit)}</p>
        <p><strong>KiÅŸi BaÅŸÄ± Eklenen KÃ¢r:</strong> ${toSAR(data.profitAmountSAR)}</p>
        <hr>
        <p style="font-size: 1.2em;"><strong>KÄ°ÅÄ° BAÅI SATIÅ FÄ°YATI: ${toSAR(data.finalPricePerPersonSAR)}</strong></p>
        <hr>
        <p><strong>Toplam Grup SatÄ±ÅŸ FiyatÄ±:</strong> ${toSAR(data.totalGroupPriceSAR)}</p>
    `;
    show('result');
}

function calculateDateInfo() {
    try {
        const startValue = getElement('travelStartDate').value;
        const endValue = getElement('travelEndDate').value;
        if (!startValue || !endValue) return;

        const start = new Date(startValue);
        const end = new Date(endValue);
        if (end < start) {
            getElement('totalTravelDays').textContent = "HatalÄ± tarih aralÄ±ÄŸÄ±!";
            return;
        }

        const totalDays = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
        getElement('totalTravelDays').textContent = `${totalDays} gÃ¼n`;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (start < today) {
            getElement('daysUntilTravel').textContent = "GeÃ§miÅŸ bir tur";
        } else {
            const days
