<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Umre Hesaplama SÜPER PRO - by Ercan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; user-select: none; }
        #app { max-width: 1000px; margin: 20px auto; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 12px; border-left: 5px solid #1976D2; }
        h3 { color: #1976D2; margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        label { display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: #1976D2; outline: none; }
        button { width: 100%; background: linear-gradient(135deg, #2E7D32, #4CAF50); color: white; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .nights-display, .total-display { padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 15px; flex: 1; }
        .nights-display { background: #e3f2fd; }
        .total-display { background: #e8f5e9; }
        @media (max-width: 768px) { .form-row { flex-direction: column; gap: 15px; } }
    </style>
</head>
<body>
    <div id="app">
        <h1>🕋 Umre Hac SÜPER PRO Sistem</h1>
        
        <div class="section">
            <h3>💾 VERİ YÖNETİMİ</h3>
            <div class="form-row">
                <button onclick="saveCalculation()" style="background: #4CAF50;">💾 Hesaplamayı Kaydet</button>
                <button onclick="document.getElementById('fileInput').click()" style="background: #2196F3;">📂 Hesaplamayı Yükle</button>
                <button onclick="exportToExcel()" style="background: #1D6F42;">📊 Excel'e Aktar</button>
            </div>
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">
        </div>

        <div class="section">
            <h3>🗓️ SEYAHAT TARİHİ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Başlangıç Tarihi</label>
                    <input type="date" id="travelStartDate" onchange="calculateDateInfo()">
                </div>
                <div class="form-group">
                    <label>Bitiş Tarihi</label>
                    <input type="date" id="travelEndDate" onchange="calculateDateInfo()">
                </div>
            </div>
            <div class="form-row">
                <div class="nights-display" id="daysUntilTravel">Tarih seçin</div>
                <div class="total-display" id="totalTravelDays">0 gün</div>
            </div>
        </div>

        <div class="section">
            <h3>👥 GRUP BİLGİLERİ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Müşteri / Grup Adı</label>
                    <input type="text" id="customerName" placeholder="Rapor için önemli">
                </div>
                <div class="form-group">
                    <label>Yolcu Sayısı</label>
                    <input type="number" id="paxCount" placeholder="Örn: 4" min="1" oninput="calculateAll()">
                </div>
            </div>
        </div>

        <div class="section">
            <h3>💵 TEMEL MALİYETLER (Kişi Başı)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Vize Ücreti (USD)</label>
                    <input type="number" id="visaCost" value="145" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>Uçak Bileti (USD)</label>
                    <input type="number" id="flightCost" placeholder="Örn: 850" oninput="calculateAll()">
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>🏨 OTEL MALİYETLERİ (Gecelik / SAR)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Mekke Otel Fiyatı (Kişi Başı)</label>
                    <input type="number" id="makkahHotelCost" placeholder="Örn: 80" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>Medine Otel Fiyatı (Kişi Başı)</label>
                    <input type="number" id="madinahHotelCost" placeholder="Örn: 60" oninput="calculateAll()">
                </div>
            </div>
             <div class="form-row">
                <div class="form-group">
                    <label>Mekke'de Kalınacak Gece</label>
                    <input type="number" id="makkahNights" placeholder="Örn: 10" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>Medine'de Kalınacak Gece</label>
                    <input type="number" id="madinahNights" placeholder="Örn: 4" oninput="calculateAll()">
                </div>
            </div>
        </div>

        <div class="section">
            <h3>⚙️ KÂR ve KUR</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Kâr Yüzdesi (%)</label>
                    <input type="number" id="profitPercentage" value="15" oninput="calculateAll()">
                </div>
                <div class="form-group">
                    <label>1 USD = ? SAR</label>
                    <input type="number" id="exchangeRate" placeholder="Kur bekleniyor..." step="0.0001" oninput="calculateAll()">
                </div>
            </div>
        </div>
        
        <button onclick="calculateAll()">💰 HESAPLA</button>
        <button onclick="resetForm()" style="background: #D32F2F;">🔄 SIFIRLA</button>

        <div id="result" class="section" style="display:none; background-color: #e0f2f1;">
            <h3 style="color: #00796b;">📊 HESAPLAMA SONUCU</h3>
            <div id="resultContent" style="font-size: 1.1em; line-height: 1.8;"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    fetchLiveRates();
});

// === API ve KUR İŞLEMLERİ ===
async function fetchLiveRates() {
    // -----------------------------------------------------------------------
    // !!! BURAYA KENDİ YENİ VE GİZLİ API ANAHTARINIZI GİRİN !!!
    // -----------------------------------------------------------------------
    const apiKey = "6c24409c9a57c109735b8d47";

    if (!apiKey || apiKey === "YENİ_VE_GİZLİ_ANAHTARINIZI_BURAYA_YAPIŞTIRIN") {
        console.warn("API Anahtarı eksik. Lütfen kod içerisine anahtarınızı girin. Varsayılan kur (3.75) kullanılıyor.");
        getElement('exchangeRate').value = 3.75;
        return;
    }

    try {
        const response = await fetch(`https://v6.exchangerate-api.com/v6/${apiKey}/latest/USD`);
        if (!response.ok) throw new Error('API yanıtı başarısız oldu.');
        const data = await response.json();
        const rate = data.conversion_rates.SAR;
        if (rate) {
            getElement('exchangeRate').value = rate.toFixed(4);
        } else {
            throw new Error('SAR kuru verisi bulunamadı.');
        }
    } catch (error) {
        console.error("Kur çekme hatası:", error);
        getElement('exchangeRate').value = 3.75; // Hata durumunda varsayılan kur
    }
}

// === HESAPLAMA FONKSİYONLARI ===
function calculateAll() {
    const paxCount = getValue('paxCount', true);
    if (paxCount === 0) {
        hide('result');
        return;
    }

    // Değerleri al
    const visaCostUSD = getValue('visaCost');
    const flightCostUSD = getValue('flightCost');
    const makkahHotelCostSAR = getValue('makkahHotelCost');
    const madinahHotelCostSAR = getValue('madinahHotelCost');
    const makkahNights = getValue('makkahNights', true);
    const madinahNights = getValue('madinahNights', true);
    const profitPercentage = getValue('profitPercentage');
    const exchangeRate = getValue('exchangeRate');

    if (exchangeRate === 0) {
        alert("Lütfen geçerli bir döviz kuru girin veya bekleyin.");
        return;
    }

    // Maliyetleri hesapla
    const baseCostUSD = visaCostUSD + flightCostUSD;
    const hotelCostSAR = (makkahHotelCostSAR * makkahNights) + (madinahHotelCostSAR * madinahNights);
    
    const totalCostSAR_beforeProfit = (baseCostUSD * exchangeRate) + hotelCostSAR;
    const profitAmountSAR = totalCostSAR_beforeProfit * (profitPercentage / 100);
    const finalPricePerPersonSAR = totalCostSAR_beforeProfit + profitAmountSAR;
    
    const totalGroupPriceSAR = finalPricePerPersonSAR * paxCount;

    // Sonuçları global bir değişkende sakla (Excel için)
    window.lastCalculation = {
        paxCount,
        visaCostUSD,
        flightCostUSD,
        hotelCostSAR,
        totalCostSAR_beforeProfit,
        profitAmountSAR,
        finalPricePerPersonSAR,
        totalGroupPriceSAR
    };

    displayResults(window.lastCalculation);
}

function displayResults(data) {
    const resultDiv = getElement('resultContent');
    const toSAR = (val) => val.toFixed(2) + " SAR";

    resultDiv.innerHTML = `
        <p><strong>Kişi Başı Toplam Maliyet (Kâr Hariç):</strong> ${toSAR(data.totalCostSAR_beforeProfit)}</p>
        <p><strong>Kişi Başı Eklenen Kâr:</strong> ${toSAR(data.profitAmountSAR)}</p>
        <hr>
        <p style="font-size: 1.2em;"><strong>KİŞİ BAŞI SATIŞ FİYATI: ${toSAR(data.finalPricePerPersonSAR)}</strong></p>
        <hr>
        <p><strong>Toplam Grup Satış Fiyatı:</strong> ${toSAR(data.totalGroupPriceSAR)}</p>
    `;
    show('result');
}

function calculateDateInfo() {
    try {
        const startValue = getElement('travelStartDate').value;
        const endValue = getElement('travelEndDate').value;
        if (!startValue || !endValue) return;

        const start = new Date(startValue);
        const end = new Date(endValue);
        if (end < start) {
            getElement('totalTravelDays').textContent = "Hatalı tarih aralığı!";
            return;
        }

        const totalDays = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
        getElement('totalTravelDays').textContent = `${totalDays} gün`;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (start < today) {
            getElement('daysUntilTravel').textContent = "Geçmiş bir tur";
        } else {
            const days
